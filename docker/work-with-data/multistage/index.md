---
metaTitle: Мультистейдж сборка в Docker
metaDescription: Узнайте как мультистейдж сборка в Docker улучшает процесс создания контейнеров. Изучите преимущества уменьшения размера образов и упрощения управления зависимостями
author: Алексей Иванов
title: Мультистейдж сборка в Docker
preview: Исследуйте как мультистейдж сборка в Docker позволяет создавать компактные и эффективные образы. Пошаговые примеры и объяснения помогут понять принципы работы этой технологии
---

## Введение

Когда дело касается работы с Docker, одной из повседневных задач является создание контейнеров, которые эффективны, малы по размеру и при этом содержат всё необходимое для работы приложения. Однако, как часто это бывает, наши образы Docker могут раздуваться до значительных размеров из-за лишних зависимостей и промежуточных файлов. Мультистейдж сборка в Docker – это инструмент, который эффективно решает эту проблему. Позвольте мне познакомить вас с этой темой подробнее, объяснив, как именно она может улучшить ваш рабочий процесс.

## Преимущества мультистейдж сборки

### Уменьшение размера образа

Мультистейдж сборка позволяет вам разделять процесс сборки на этапы, что особенно полезно для управления зависимостями и созданием финальных образов. Например, вы можете использовать один этап для установки всех необходимых инструментов сборки, а затем исключить их на более поздних этапах, оставляя только минимальный набор для исполнения приложения. Это значительно сокращает конечный размер образа.

### Улучшение безопасности

Меньший образ не только загружается быстрее и экономит место, но и уменьшает площадь атаки. Убирая ненужные инструменты и библиотеки, вы сокращаете потенциал опасных эксплойтов или уязвимостей, оставляя только необходимые компоненты для безопасного исполнения вашего кода.

## Основы мультистейдж сборки

### Как это работает?

Давайте начнем с ключевой концепции: в мультистейдж сборке вы можете создавать множество этапов сборки в одном Dockerfile. Каждый этап начинается с директивы `FROM`, что позволяет вам использовать разные базовые образы для различных нужд. На финальном этапе вы обычно копируете только необходимые артефакты из предыдущих этапов.

### Пример мультистейдж Dockerfile

Покажу вам, как это реализовано на практике. Предположим, у нас есть простое приложение на Go. Мы хотим снизить размер конечного образа, чтобы ускорить развертывание.

```dockerfile
# Первый этап: сборки
FROM golang:1.17 AS builder

WORKDIR /app

# Копируем исходный код и зависимости
COPY . .
RUN go mod download

# Сборка приложения
RUN go build -o myapp

# Второй этап: создание минимального финального образа
FROM alpine:latest

WORKDIR /root/

# Копируем из предыдущего этапа
COPY --from=builder /app/myapp .

# Устанавливаем необходимые библиотеки
RUN apk --no-cache add ca-certificates

# Определяем команду по умолчанию
CMD ["./myapp"]
```

Как видите, в этом Dockerfile мы используем два этапа: `builder` и `alpine`. На первом этапе происходит установка всех зависимостей и сборка приложения на основе официального образа golang. На втором этапе мы создаем минимальный образ на основе Alpine Linux, копируя в него только собранный бинарный файл из первого этапа.

## Гибкость и специализация

### Разные этапы для разных задач

Смотрите, как это может быть полезно: вы можете добавлять дополнительные этапы для выполнения отдельных задач, таких как тестирование, линтинг или установка дополнительных компонентов. Это позволяет вам структурировать процесс сборки так, чтобы на каждом этапе выполнялась только одна задача.

### Определение различного окружения для этапов

На каждом этапе вы можете использовать разные образы для различных окружений. Например, вы можете использовать один образ для разработки и другой для продакшена, переключаясь между ними в зависимости от требований к конечному приложению.

## Советы по использованию мультистейдж сборки

### Устранение лишних компонентов

Не забывайте удалять ненужные файлы и кеши после завершения установки зависимостей. Это может дополнительно снизить размер образа и улучшить его безопасность.

### Использование кэширования

Старайтесь оптимизировать порядок слоев в Dockerfile, чтобы максимально использовать кэш Docker. Например, редко изменяющиеся зависимости выносите в начало файла.

В мультистейдж сборке важное значение имеет структура Dockerfile – правильное использование кастомных этапов и стратегия их построения может значительно повысить продуктивность вашего рабочего процесса.

Теперь, когда вы понимаете основные идеи и принципы мультистейдж сборки, вы можете начинать внедрять эту технику в своих проектах. Ее использование позволяет сократить размер образов, облегчить управление зависимостями и повысить безопасность приложений, работающих в контейнерах. Надеюсь, эти советы и примеры помогут вам извлечь максимальную пользу из Docker.